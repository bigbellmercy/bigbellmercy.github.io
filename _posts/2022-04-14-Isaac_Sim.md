---
title: "Isaac Sim 사용법"
date: 2022-4-14 17:57:00 +09:00
categories: Digital_Twin
---

# 목적
NVIDIA 사의 '디지털 트윈'(digital twin)을 위한 컴퓨터 시뮬레이션 소프트웨어인 Isaac Sim의 사용법을 설명합니다.

# 실행 환경 요건
- 3D 그래픽 처리가 많이 쓰이기에, 컴퓨터에 NVIDIA사의 고성능 GPU(Graphic Processing Unit) 카드가 설치되어 있어야 함.
- 운영체제는 윈도우와, 리눅스 각각 쓸 수 있고, AWS와 같은 클라우드 컴퓨팅 환경에서도 실행 가능함.
- 아마존 AWS 상에서 실행되는, Isaac Sim의 설치가 가능한 Ubuntu 18.04 이미지가 AWS에 제공되나, 웹브라우저에서 창으로 표시되므로 사용 제약이 있음.
- 아마존 AWS 상에서, 무료로 제공하는 원격 데스크톱 소프트웨어인 DCV를 설치하면, GUI 데스크톱 환경에서도 실행 가능하므로 사용 제약이 적어짐. 

# 아마존 AWS 상에서 실행 방법
## AWS 인스턴스 생성
참고 자료 1을 참고할 것.
1. EC2 화면에서 Launch Instances를 누르고 검색란에서 IsaacSim으로 찾아, 최근의 것을 고른다.
2. Instance Type으로는 NVIDIA GPU가 장착된 g4dn에서 하나를 고른다.
3. Security에서 기존 규칙(rule)을 지우고, 새 규칙을 만들어 All trafic을 고르고, My IP를 골라,
 내 컴퓨터만 접속하게 한다.
4. 만들어 둔 PEM Key를 고르고, 계속 진행하여, Launch를 누른다.
5. 만들어진 인스탄스를 고르고 Connect를 눌러 SSH 탭의 마지막 줄에서 ssh 접속 명령을 사한다.
6. 윈도우나 리눅스로 된 사용자 컴퓨터에서 명령창을 하나 띄우고,
7. 명령창에서 cd 명령으로 PEM key 파일이 있는 경로로 이동한다.
8. 앞에서 복사된 명령을 붙여넣고 실행하여 가상 컴퓨터에 ssh로 접속한다.
 
## Isaac Sim 설치
참고 자료 2번 대로 설치하되, Nucleus 서버 관련 오류가 있으므로, 컨테이너에 들어 가면 바로 다음을 실행하여 고친다:
>sed -i 's|"options": "{\\"timeout\\": 600, \\"host\\":\\"ov-isaac.s3.us-west-1.amazonaws.com\\",\\"service\\":\\"s3\\",\\"secure\\":false,\\"redirection\\":\\"http://dpcil1p2xgdf8.cloudfront.net/\\"}",|"options": "{\\"timeout\\": 600, \\"host\\":\\"d28dzv1nop4bat.cloudfront.net\\",\\"service\\":\\"s3\\",\\"secure\\":false,\\"redirection\\":\\"https://d28dzv1nop4bat.cloudfront.net\\"}",|' /isaac-sim/installers/nucleus/Nucleus/omni.server.app.config.json

아래는 참고 자료:
https://forums.developer.nvidia.com/t/isaac-sim-first-run-error-using-aws-updated/211197/3?u=bigbellmercy

## Isaac 예제 실행
- Isaac Sim의 Isaac Example 메뉴에서 원하는 것을 골라서 실행 할 수 있음.
- 보통, 예제를 고른 뒤 나오는 창에서, Load를 누르고, 삼각형 Play 단추를 누르면 실행됨. 필요시, Reset으로 초기화나 Clear로 세계를 지울 수 있음.
- RoboParty를 누르고, Reset 누르고 Party를 누르면 로봇들이 움직이는 것을 볼 수 있으며, AWS 정상 실행 시, g4dn.4xlarge에서 성능 문제 없었으나,
- AWS 초기 사용 시에, 몇일 동안 마우스 커서도 못 쫒아갈 정도로 느려지는 현상과, 원격 화면 접속이 자주 끊기는 현상이 났었으나, 그 뒤로 증상이 없어짐.
- 예제 창의 오른쪽 위의, 연필 모양 아이콘을 누르면 관련된 파이썬 코드가 VSCode에서 나타남. 폴더 아이콘을 누르면, 웹브라우저로 해당 파이썬 폴더가 나타남.


## Isaac Sim을 도커 컨테이너로 실행할 때, WebSocket 대신 데스크톱 환경에서 표시되게 하는 방법
1. 컨테이어 실행 전에 X window 원격 디스플레이 기능을 활성화한다.
```
xhost +
```

2. 컨테이너 실행 시 X window 사용 옵션을 넣는다. (-e와 .X11-unix 부분)
```
sudo docker run --name isaac-sim --entrypoint bash -it --gpus all -e "ACCEPT_EULA=Y" --restart unless-stopped --network=host \
-v ~/docker/isaac-sim/cache/ov:/root/.cache/ov:rw \
-v ~/docker/isaac-sim/cache/glcache:/root/.cache/nvidia/GLCache:rw \
-v ~/docker/isaac-sim/cache/computecache:/root/.nv/ComputeCache:rw \
-v ~/docker/isaac-sim/logs:/root/.nvidia-omniverse/logs:rw \
-v ~/docker/isaac-sim/config:/root/.nvidia-omniverse/config:rw \
-v ~/docker/isaac-sim/data:/root/.local/share/ov/data:rw \
-v ~/docker/isaac-sim/documents:/root/Documents:rw \
-e DISPLAY=$DISPLAY \
-v "/tmp/.X11-unix:/tmp/.X11-unix:rw" \
nvcr.io/nvidia/isaac-sim:2021.2.1
```

3. 컨테이너 속에서 Isaac Sim을 데스크톱 환경에서 실행하도록 명령한다
```
./runapp.sh
```

## Isaac Sim 재실행
Isaac Sim을 설치한 뒤로 다시 실행할 때에는 다음의 방법으로 실행한다.
1. Nucleus 서버를 실행한다: 
>installers/nucleus/System\ Monitor/omni-system-monitor &
2. 웹브라우저에서 이전처럼 Nucleus에 접속한다.
3. Isaac Sim을 실행하고, 이전처럼 웹소켓에 접속한다:
>./isaac-sim.headless.websocket.sh --allow-root


# 문제점
## 튜토리얼(자습서) 실행의 한계
Isaac Sim의 자습서는 AWS와 같은 가상 환경에서가 아닌 실제 컴퓨터에 설치된 상태를 기준으로 작성되었기에, 자습서의 일부 기능들이 실행되지 않는다.
예를 들어, 파이썬 코드를 보는 단추를 누르면, Visual Studio Code 창이 떠야 하는데, AWS는 웹소켓으로 Isaac Sim 창만을 원격으로 보여 주기에, VSC는 나타나지 않는다.
이를 해결하려면, 가상 컴퓨터에 GUI용 데스크톱 소프트웨어를 설치하고, 원격 데스크톱 서비스를 실행하여야 하는데, 아래 기술한 것처럼 이것도 쉽지 않다.

## 원격 데스크톱 실행 문제
AWS의 가상 컴퓨터에 접속한 상태에서 리눅스의 GUI 데스크톱 화면을 사용자의 지역 컴퓨터에서 원격으로 접속하여 마치 실제 리눅스 GUI를 쓰는 것처럼 할 수가 있는데, 다음과 같은 문제들이 발견되었다:
- AWS가 제공하는 Ubuntu 18.04용 AMI 이미지에서는, 원격 데스크톱 서비스인 xrdp가 실행되어, 우분투 GUI가 원격에서 잘 표시가 되나, 문제는, Isaac Sim용 AMI 이미지에서는 이것이 되지 않고, 원격 로그인 후, 빈 화면만 나타나는 문제가 발생하였다. 이를 해결하려고, 인터넷의 여러 방법을 시도하고, AWS의 엔지니어의 지원을 받았으나, 결론은 안되는 것으로 되었다.
- 다른 대안으로서, Ubuntu 공식 사이트에서 추천하는 과정을 따라, xrdp 대신에 tightvncserver를 설치하였는데, 원격 접속이 되었으나, 데스크톱 환경이 빈약하고, 심지어 terminal 소프트웨어가 실행이 되지 않고, 소프트웨어 센터에서도 제공하지 않는 등 여러가지 문제들이 나타나고, 앞으로도 계속 나타날 것으로 예상되어, 쓰기가 어려울 것으로 보인다.
- 또 다른 대안으로서, AWS에서 이러한 GUI용 원격 데스크톱 서비스를 위해, DCV라는 서비스를 제공하며, EC2에 적용하는 것이 무료 사용이고, 이를 쓰면 된다고 한다. 리눅스에 이미 xrdp와 같은 원격 데스크톱 서비스가 있는데, DCV라는 서비스가 또 있는 것으로 보아, 이러한 문제들이 AWS에 생겨서 따로 만든 서비스로 보인다.
- AWS에 DCV를 설치하여, GNOME 데스크톱 환경에서, Isaac Sim이 실행 성공하였으며, WebSocket 실행 대신, 원격 데스크톱 환경에서도 실행에 성공하였다.


# 문제 해결

## Nvidia 드라이버 문제 해결
- Isaac Sim 실행 도중에 강제 중단된 경우, nvidia-smi 명령을 실행하면 드라이버가 나타나지 않는 경우가 있는데, 이 때는 Nvidia 드라이버를 안내서대로 다시 설치하면 해결된다.

## Nucleus 접속 문제 해결법
Isaac 예제가 일부 실행안되거나, Nucleus에 접속이 안된다는 오류가 뜨면, 참고 자료 3번의 방법으로 해결한다.


# Isaac Sim 사용 개념

## Isaac Sim의 화면 구성
- Viewport: 3D 화면이 나타나는 창
- Stage: 3D 가상 세계의 물체들이 나무구조로 나열되는 곳. 항목을 선택하여 변경 가능.
- Content: Nucleus 서버의 파일들과, 내 컴퓨터의 파일들을 보고, 사용 가능.
- Console: 각종 오류/경고/정보 메시지들을 보거나 검색 가능.
- Property: 선택된 물체의 속성 값들을 보거나 변경 가능.

## Isaac Sim의 주요 메뉴
- File: 새로운 가상 세계를 만들거나 불러올 수 있음.
- Create: 각종 3D 도형들을 만들 수 있음.
- Isaac Examples: 제공되는 예제들을 불러올 수 있음.
- Window: 화면을 이루는 여러 창들을 켜거나 끌 수 있음.

## Nuclues 서버
- 여러 개발자들이 시뮬레이션을 공동 개발하기 위해 공유하는 파일 서버, 하나 이상의 컴퓨터에 Nucleus 서버를 둘 수 있음.
- Isaac Examples 중 일부가 Nucleus 서버에 들어 있음.

## Visual Studio Code
- 가상 세계에 로봇 등의 물체를 배치하고 움직이게 하기 위한 코드를 파이썬 언어로 작성하며, 그 무료 편집기로 MS 사의 Visual Studio Code(VSCode)를 씀
- 수정된 코드를 저장하면 Isaac Sim이 인지하여 변경 사항이 반영되나, 일부 한계가 있음.

## Jupyter Notebook
- 파이썬 코드를 VSCode 대신에 주피터 노트북에서 편집할 수 있으며, 한 줄씩 실행하면 Isaac Sim에 순차대로 반영됨.

## USD 파일
- 로봇 등의 가상 물체는 USD 파일로 저장되며 이는 Universal Scene Description이라는 유명한 Pixar 사의 표준임.
- Content 창에서 USD 파일을 끌어서 Viewport에 놓으면 그 물체가 그 세계에 놓이게 됨.
- 파이썬 코드에서도 USD 파일을 가지고 가상 세계에 놓을 수도 있음.
- 로봇의 USD 파일은 3D CAD에서 로봇을 설계하고 저장하여 만들 수 있음.
- Prim: Primitive의 약어로, USD의 Scene을 구성하는 원소(element)로서, 다각형 등이 있다. 하나의 Prim은 자식 Prim들을 가질 수 있다.
- USD의 Scene, Stage, Layer 등의 개념은 아래 설명 자료를 참조할 것.
- USD 기초 설명 자료: https://www.sidefx.com/docs/houdini/solaris/usd.html

## Asset
가상 세계의 각종 물체들을 asset(자산)이라고 부름.

## Physics
- 중력, 충돌 등이 작동하는 물리 엔진
- Stage / PhsyicsScene의 속성을 조정 가능
- Broadphase type: 물체 충돌과 관련된 시뮬레이션 실행 단계. 관심영역(Region of Interest)만을 대상으로 한다.
    - sweep-and-prune (SAP): 많은 물체가 자고(sleep) 있을 때 효과가 좋음
    - multi box pruning (MBP): 많을 물체가 움직이고 있을 때 효과가 좋음
- Enblae GPU dynamics: 물체가 많을 때는 GPU를 켜면 효과가 좋으나, 반대로 적을 때는 GPU를 꺼서 CPU만을 쓰는게 효과가 좋음 (아마, 물체가 적으면 CPU와 GPU 사이의 잦은 컨텍스트 스위칭 시간 문제 때문에 그런 듯함)

# 참고 자료
상기 내용은 아래의 내용을 기반으로 작성되었음
1. https://docs.omniverse.nvidia.com/app_isaacsim/app_isaacsim/install_advanced_cloud_setup_aws.html#isaac-sim-setup-aws-requirements
2. https://docs.omniverse.nvidia.com/app_isaacsim/app_isaacsim/install_advanced.html#isaac-sim-setup-remote-headless-container
3. https://forums.developer.nvidia.com/t/isaac-sim-first-run-error-using-aws-updated/211197/3?u=bigbellmercy
4. Isaac Sim의 컨테이너 사용 설치 방법: https://forums.developer.nvidia.com/t/solution-how-to-run-isaac-sim-on-ubuntu-desktop-environment-using-docker-container-instead-of-websocket/215638?u=bigbellmercy
5. Isaac Sim의 주피터 노트북 사용 문제 해법: https://forums.developer.nvidia.com/t/solution-how-to-resolve-the-temp-jupyter-stage-usd-problem-in-hello-world-tutorial-bug/215647?u=bigbellmercy



